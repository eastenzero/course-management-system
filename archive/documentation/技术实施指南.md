# è¯¾ç¨‹ç®¡ç†ç³»ç»Ÿ - æŠ€æœ¯å®æ–½æŒ‡å—

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚
- Python 3.9+
- Node.js 16+
- PostgreSQL 13+
- Redis 6+

### é¡¹ç›®å¯åŠ¨
```bash
# åç«¯å¯åŠ¨
cd backend
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r requirements.txt
python manage.py migrate
python manage.py runserver

# å‰ç«¯å¯åŠ¨
cd frontend
npm install
npm start
```

## ğŸ§ª æµ‹è¯•å®æ–½

### 1. åç«¯æµ‹è¯•è®¾ç½®

#### å®‰è£…æµ‹è¯•ä¾èµ–
```bash
pip install pytest pytest-django pytest-cov factory-boy
```

#### æµ‹è¯•é…ç½® (backend/pytest.ini)
```ini
[tool:pytest]
DJANGO_SETTINGS_MODULE = course_management.settings.test
python_files = tests.py test_*.py *_tests.py
addopts = --cov=apps --cov-report=html --cov-report=term-missing
```

#### ç¤ºä¾‹æµ‹è¯•æ–‡ä»¶ (apps/students/tests/test_views.py)
```python
import pytest
from django.test import TestCase
from django.contrib.auth import get_user_model
from rest_framework.test import APIClient
from rest_framework import status
from apps.students.models import StudentProfile

User = get_user_model()

class StudentAPITestCase(TestCase):
    def setUp(self):
        self.client = APIClient()
        self.student_user = User.objects.create_user(
            username='student001',
            email='student@test.com',
            user_type='student'
        )
        self.client.force_authenticate(user=self.student_user)
    
    def test_get_dashboard(self):
        response = self.client.get('/api/v1/students/dashboard/')
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertIn('student_info', response.data)
```

### 2. å‰ç«¯æµ‹è¯•è®¾ç½®

#### å®‰è£…æµ‹è¯•ä¾èµ–
```bash
npm install --save-dev @testing-library/react @testing-library/jest-dom @testing-library/user-event
```

#### ç¤ºä¾‹ç»„ä»¶æµ‹è¯• (src/components/education/__tests__/CourseCard.test.tsx)
```typescript
import React from 'react';
import { render, screen } from '@testing-library/react';
import '@testing-library/jest-dom';
import CourseCard from '../CourseCard';

const mockCourse = {
  id: 1,
  code: 'CS101',
  name: 'è®¡ç®—æœºç§‘å­¦å¯¼è®º',
  credits: 3,
  hours: 48,
  course_type: 'required',
  department: 'è®¡ç®—æœºå­¦é™¢',
  semester: '2024-2025-1'
};

describe('CourseCard', () => {
  test('renders course information correctly', () => {
    render(<CourseCard course={mockCourse} />);
    
    expect(screen.getByText('è®¡ç®—æœºç§‘å­¦å¯¼è®º')).toBeInTheDocument();
    expect(screen.getByText('CS101')).toBeInTheDocument();
    expect(screen.getByText('3å­¦åˆ† | 48å­¦æ—¶')).toBeInTheDocument();
  });
});
```

## ğŸ“Š è¯¾ç¨‹è¡¨ç³»ç»Ÿå®æ–½

### 1. æ•°æ®åº“æ¨¡å‹åˆ›å»º

#### åˆ›å»ºè¿ç§»æ–‡ä»¶
```bash
cd backend
python manage.py startapp schedules  # å¦‚æœè¿˜æ²¡æœ‰
```

#### æ¨¡å‹å®šä¹‰ (apps/schedules/models.py)
```python
from django.db import models
from apps.courses.models import Course
from apps.classrooms.models import Classroom

class TimeSlot(models.Model):
    """æ—¶é—´æ®µæ¨¡å‹"""
    name = models.CharField(max_length=50, verbose_name='æ—¶é—´æ®µåç§°')
    day_of_week = models.IntegerField(
        choices=[(i, f'å‘¨{["ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","æ—¥"][i-1]}') for i in range(1, 8)],
        verbose_name='æ˜ŸæœŸ'
    )
    start_time = models.TimeField(verbose_name='å¼€å§‹æ—¶é—´')
    end_time = models.TimeField(verbose_name='ç»“æŸæ—¶é—´')
    
    class Meta:
        verbose_name = 'æ—¶é—´æ®µ'
        verbose_name_plural = 'æ—¶é—´æ®µ'
        unique_together = ['day_of_week', 'start_time', 'end_time']

class CourseSchedule(models.Model):
    """è¯¾ç¨‹å®‰æ’æ¨¡å‹"""
    course = models.ForeignKey(Course, on_delete=models.CASCADE, verbose_name='è¯¾ç¨‹')
    time_slot = models.ForeignKey(TimeSlot, on_delete=models.CASCADE, verbose_name='æ—¶é—´æ®µ')
    classroom = models.ForeignKey(Classroom, on_delete=models.CASCADE, verbose_name='æ•™å®¤')
    weeks = models.CharField(max_length=50, verbose_name='å‘¨æ¬¡', help_text='å¦‚ï¼š1-18å‘¨')
    
    class Meta:
        verbose_name = 'è¯¾ç¨‹å®‰æ’'
        verbose_name_plural = 'è¯¾ç¨‹å®‰æ’'
        unique_together = ['time_slot', 'classroom', 'weeks']
```

### 2. å†²çªæ£€æµ‹ç®—æ³•

#### æœåŠ¡ç±» (apps/schedules/services.py)
```python
from typing import List, Dict
from .models import CourseSchedule, TimeSlot

class ScheduleConflictDetector:
    """è¯¾ç¨‹å®‰æ’å†²çªæ£€æµ‹å™¨"""
    
    def check_time_conflict(self, course_id: int, time_slot_id: int, weeks: str) -> List[Dict]:
        """æ£€æŸ¥æ—¶é—´å†²çª"""
        conflicts = []
        
        # æ£€æŸ¥å­¦ç”Ÿæ—¶é—´å†²çª
        student_conflicts = self._check_student_conflicts(course_id, time_slot_id, weeks)
        conflicts.extend(student_conflicts)
        
        # æ£€æŸ¥æ•™å¸ˆæ—¶é—´å†²çª
        teacher_conflicts = self._check_teacher_conflicts(course_id, time_slot_id, weeks)
        conflicts.extend(teacher_conflicts)
        
        return conflicts
    
    def check_classroom_conflict(self, classroom_id: int, time_slot_id: int, weeks: str) -> List[Dict]:
        """æ£€æŸ¥æ•™å®¤å†²çª"""
        existing_schedules = CourseSchedule.objects.filter(
            classroom_id=classroom_id,
            time_slot_id=time_slot_id
        )
        
        conflicts = []
        for schedule in existing_schedules:
            if self._weeks_overlap(schedule.weeks, weeks):
                conflicts.append({
                    'type': 'classroom',
                    'message': f'æ•™å®¤åœ¨è¯¥æ—¶é—´æ®µå·²è¢«è¯¾ç¨‹ {schedule.course.name} å ç”¨',
                    'course': schedule.course.name
                })
        
        return conflicts
    
    def _weeks_overlap(self, weeks1: str, weeks2: str) -> bool:
        """æ£€æŸ¥å‘¨æ¬¡æ˜¯å¦é‡å """
        # ç®€åŒ–å®ç°ï¼Œå®é™…éœ€è¦è§£æå‘¨æ¬¡å­—ç¬¦ä¸²
        return True  # æš‚æ—¶è¿”å›Trueï¼Œéœ€è¦å…·ä½“å®ç°
```

## ğŸ¯ æˆç»©ç³»ç»Ÿå¢å¼º

### 1. æˆç»©ç»„æˆé…ç½®

#### æ¨¡å‹æ‰©å±• (apps/courses/models.py)
```python
class GradeComponent(models.Model):
    """æˆç»©ç»„æˆé…ç½®"""
    course = models.ForeignKey(Course, on_delete=models.CASCADE, related_name='grade_components')
    name = models.CharField(max_length=100, verbose_name='æˆç»©é¡¹ç›®åç§°')
    weight = models.DecimalField(max_digits=5, decimal_places=2, verbose_name='æƒé‡(%)')
    max_score = models.DecimalField(max_digits=5, decimal_places=2, default=100, verbose_name='æ»¡åˆ†')
    is_required = models.BooleanField(default=True, verbose_name='æ˜¯å¦å¿…éœ€')
    
    class Meta:
        verbose_name = 'æˆç»©ç»„æˆ'
        verbose_name_plural = 'æˆç»©ç»„æˆ'
        unique_together = ['course', 'name']

# æ‰©å±•ç°æœ‰Gradeæ¨¡å‹
class Grade(models.Model):
    # ... ç°æœ‰å­—æ®µ ...
    component = models.ForeignKey(
        GradeComponent, 
        on_delete=models.CASCADE, 
        null=True, 
        blank=True,
        verbose_name='æˆç»©ç»„æˆ'
    )
```

### 2. æˆç»©è®¡ç®—æœåŠ¡

#### æœåŠ¡ç±» (apps/courses/services.py)
```python
class GradeCalculationService:
    """æˆç»©è®¡ç®—æœåŠ¡"""
    
    def calculate_final_grade(self, enrollment_id: int) -> Dict:
        """è®¡ç®—æœ€ç»ˆæˆç»©"""
        enrollment = Enrollment.objects.get(id=enrollment_id)
        course = enrollment.course
        
        # è·å–æˆç»©ç»„æˆé…ç½®
        components = course.grade_components.all()
        if not components.exists():
            # å¦‚æœæ²¡æœ‰é…ç½®ï¼Œä½¿ç”¨é»˜è®¤è®¡ç®—æ–¹å¼
            return self._calculate_simple_grade(enrollment)
        
        # æŒ‰æƒé‡è®¡ç®—
        total_weighted_score = 0
        total_weight = 0
        
        for component in components:
            grades = Grade.objects.filter(
                enrollment=enrollment,
                component=component
            )
            
            if grades.exists():
                avg_score = grades.aggregate(avg=models.Avg('score'))['avg']
                weighted_score = (avg_score / component.max_score) * 100 * (component.weight / 100)
                total_weighted_score += weighted_score
                total_weight += component.weight
        
        final_score = total_weighted_score if total_weight > 0 else 0
        
        return {
            'final_score': round(final_score, 2),
            'letter_grade': self._score_to_letter(final_score),
            'components': self._get_component_scores(enrollment, components)
        }
```

## ğŸ“± å‰ç«¯ä¼˜åŒ–å®æ–½

### 1. ä»£ç åˆ†å‰²é…ç½®

#### è·¯ç”±æ‡’åŠ è½½ (src/router/routes.tsx)
```typescript
import { lazy } from 'react';

// æ‡’åŠ è½½é¡µé¢ç»„ä»¶
const StudentDashboard = lazy(() => import('../pages/students/dashboard/StudentDashboard'));
const TeacherDashboard = lazy(() => import('../pages/teachers/dashboard/TeacherDashboard'));

// åœ¨è·¯ç”±é…ç½®ä¸­ä½¿ç”¨Suspense
import { Suspense } from 'react';
import { Spin } from 'antd';

const LazyWrapper: React.FC<{ children: React.ReactNode }> = ({ children }) => (
  <Suspense fallback={<Spin size="large" style={{ display: 'flex', justifyContent: 'center', padding: '50px' }} />}>
    {children}
  </Suspense>
);
```

### 2. çŠ¶æ€ç®¡ç†ä¼˜åŒ–

#### Redux Toolkité…ç½® (src/store/slices/educationSlice.ts)
```typescript
import { createSlice, createAsyncThunk } from '@reduxjs/toolkit';
import { studentAPI, teacherAPI } from '../../services/api';

// å¼‚æ­¥thunk
export const fetchStudentDashboard = createAsyncThunk(
  'education/fetchStudentDashboard',
  async (_, { rejectWithValue }) => {
    try {
      const response = await studentAPI.getDashboard();
      return response.data;
    } catch (error: any) {
      return rejectWithValue(error.response?.data?.error || 'è·å–æ•°æ®å¤±è´¥');
    }
  }
);

const educationSlice = createSlice({
  name: 'education',
  initialState: {
    dashboard: null,
    courses: [],
    grades: [],
    loading: false,
    error: null
  },
  reducers: {
    clearError: (state) => {
      state.error = null;
    }
  },
  extraReducers: (builder) => {
    builder
      .addCase(fetchStudentDashboard.pending, (state) => {
        state.loading = true;
        state.error = null;
      })
      .addCase(fetchStudentDashboard.fulfilled, (state, action) => {
        state.loading = false;
        state.dashboard = action.payload;
      })
      .addCase(fetchStudentDashboard.rejected, (state, action) => {
        state.loading = false;
        state.error = action.payload as string;
      });
  }
});

export default educationSlice.reducer;
```

## ğŸ³ Dockeréƒ¨ç½²é…ç½®

### 1. åç«¯Dockerfile
```dockerfile
# backend/Dockerfile
FROM python:3.9-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

EXPOSE 8000

CMD ["gunicorn", "--bind", "0.0.0.0:8000", "course_management.wsgi:application"]
```

### 2. å‰ç«¯Dockerfile
```dockerfile
# frontend/Dockerfile
FROM node:16-alpine as build

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=build /app/build /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf

EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

### 3. Docker Composeé…ç½®
```yaml
# docker-compose.yml
version: '3.8'

services:
  db:
    image: postgres:13
    environment:
      POSTGRES_DB: course_management
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:6-alpine

  backend:
    build: ./backend
    ports:
      - "8000:8000"
    depends_on:
      - db
      - redis
    environment:
      - DATABASE_URL=postgresql://postgres:password@db:5432/course_management
      - REDIS_URL=redis://redis:6379

  frontend:
    build: ./frontend
    ports:
      - "80:80"
    depends_on:
      - backend

volumes:
  postgres_data:
```

## ğŸ“ˆ ç›‘æ§å’Œæ—¥å¿—

### 1. æ—¥å¿—é…ç½® (backend/course_management/settings/production.py)
```python
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {
            'format': '{levelname} {asctime} {module} {process:d} {thread:d} {message}',
            'style': '{',
        },
    },
    'handlers': {
        'file': {
            'level': 'INFO',
            'class': 'logging.FileHandler',
            'filename': '/var/log/django/course_management.log',
            'formatter': 'verbose',
        },
    },
    'root': {
        'handlers': ['file'],
        'level': 'INFO',
    },
}
```

### 2. æ€§èƒ½ç›‘æ§
```python
# å®‰è£…ä¾èµ–
pip install django-debug-toolbar django-extensions

# åœ¨å¼€å‘ç¯å¢ƒä¸­å¯ç”¨
INSTALLED_APPS += ['debug_toolbar', 'django_extensions']
MIDDLEWARE += ['debug_toolbar.middleware.DebugToolbarMiddleware']
```

---

**å®æ–½å»ºè®®**: æŒ‰ç…§ä¼˜å…ˆçº§é€æ­¥å®æ–½ï¼Œæ¯ä¸ªåŠŸèƒ½å®Œæˆåè¿›è¡Œå……åˆ†æµ‹è¯•å†è¿›å…¥ä¸‹ä¸€é˜¶æ®µã€‚
