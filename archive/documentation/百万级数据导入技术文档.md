# ç™¾ä¸‡çº§æ•°æ®ç”Ÿæˆä¸Žå¯¼å…¥ç³»ç»Ÿ - æŠ€æœ¯æ–‡æ¡£

## ðŸ“‹ æ¦‚è¿°

è¯¾ç¨‹ç®¡ç†ç³»ç»Ÿæä¾›äº†å®Œæ•´çš„ç™¾ä¸‡çº§æ•°æ®ç”Ÿæˆä¸Žå¯¼å…¥è§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒå¤§è§„æ¨¡æ•°æ®çš„é«˜æ•ˆå¤„ç†ã€å†…å­˜ä¼˜åŒ–å’Œæ€§èƒ½ç›‘æŽ§ã€‚è¯¥ç³»ç»Ÿç»è¿‡ä¼˜åŒ–ï¼Œèƒ½å¤Ÿåœ¨æœ‰é™çš„èµ„æºçŽ¯å¢ƒä¸­ç¨³å®šè¿è¡Œï¼Œé€‚ç”¨äºŽåŽ‹åŠ›æµ‹è¯•ã€æ€§èƒ½è¯„ä¼°å’Œå¤§è§„æ¨¡éƒ¨ç½²åœºæ™¯ã€‚

---

## ðŸ—ï¸ ç³»ç»Ÿæž¶æž„

### ç™¾ä¸‡çº§æ•°æ®å¤„ç†æž¶æž„
```
æ•°æ®ç”Ÿæˆå™¨ â†’ æ‰¹å¤„ç†ç®¡ç†å™¨ â†’ å†…å­˜ä¼˜åŒ–å™¨ â†’ æ•°æ®åº“å¯¼å…¥
     â†“              â†“              â†“              â†“
  å‡æ•°æ®ç”Ÿæˆ     æ™ºèƒ½åˆ†æ‰¹      å†…å­˜ç›‘æŽ§      äº‹åŠ¡ç®¡ç†
  é…ç½®ç®¡ç†       è´Ÿè½½å‡è¡¡      åžƒåœ¾å›žæ”¶      é”™è¯¯å¤„ç†
  è¿›åº¦ç›‘æŽ§       æ£€æŸ¥ç‚¹        æµå¼å¤„ç†      æ€§èƒ½ç»Ÿè®¡
```

### æ ¸å¿ƒç»„ä»¶
- **æ•°æ®ç”Ÿæˆå™¨**: åŸºäºŽFakeråº“çš„å¤§è§„æ¨¡å‡æ•°æ®ç”Ÿæˆ
- **æ‰¹å¤„ç†ç®¡ç†å™¨**: æ™ºèƒ½æ‰¹æ¬¡åˆ†å‰²å’Œä¾èµ–å…³ç³»ç®¡ç†
- **å†…å­˜ä¼˜åŒ–å™¨**: å¯¹è±¡æ± ç®¡ç†ã€æµå¼å†™å…¥ã€åžƒåœ¾å›žæ”¶ä¼˜åŒ–
- **è¿›åº¦ç›‘æŽ§ç³»ç»Ÿ**: å®žæ—¶è¿›åº¦è·Ÿè¸ªã€é”™è¯¯å¤„ç†ã€æ£€æŸ¥ç‚¹æœºåˆ¶

---

## ðŸ“Š æ•°æ®è§„æ¨¡é…ç½®

### é¢„è®¾æ•°æ®è§„æ¨¡
| è§„æ¨¡çº§åˆ« | ç”¨æˆ·æ•°é‡ | è¯¾ç¨‹æ•°é‡ | é€‰è¯¾è®°å½• | é¢„è®¡æ—¶é—´ | å†…å­˜éœ€æ±‚ |
|---------|----------|----------|----------|----------|----------|
| æ¼”ç¤ºçº§   | 1,050    | 500      | 2,000    | 30ç§’     | 256MB    |
| å°è§„æ¨¡   | 10,000   | 1,000    | 20,000   | 5åˆ†é’Ÿ    | 512MB    |
| ä¸­è§„æ¨¡   | 100,000  | 5,000    | 200,000  | 30åˆ†é’Ÿ   | 1GB      |
| å¤§è§„æ¨¡   | 1,000,000| 20,000   | 2,000,000| 3å°æ—¶    | 2GB      |

---

## ðŸš€ å¿«é€Ÿä½¿ç”¨æŒ‡å—

### 1. æ¼”ç¤ºæ•°æ®ç”Ÿæˆï¼ˆæŽ¨èï¼‰
```bash
# ç”Ÿæˆæ¼”ç¤ºè§„æ¨¡çš„"ç™¾ä¸‡çº§"æ•°æ®ï¼ˆ1050æ¡è®°å½•ï¼‰
docker compose exec backend python quick_mega_data.py
```

### 2. è‡ªå®šä¹‰è§„æ¨¡æ•°æ®ç”Ÿæˆ
```bash
# å¤åˆ¶æ•°æ®ç”Ÿæˆè„šæœ¬åˆ°å®¹å™¨
docker cp generate_demo_mega_data.py course_management_backend:/app/

# æ‰§è¡Œå¤§è§„æ¨¡æ•°æ®ç”Ÿæˆ
docker compose exec backend python generate_demo_mega_data.py
```

### 3. ä½¿ç”¨ä¸“ä¸šæ•°æ®ç”Ÿæˆå™¨
```bash
# è¿›å…¥æ•°æ®ç”Ÿæˆå™¨ç›®å½•
cd course-management-system/data-generator

# ä½¿ç”¨é…ç½®æ–‡ä»¶ç”Ÿæˆç™¾ä¸‡çº§æ•°æ®
python mega_main.py --config mega_scale_config.yml

# è‡ªå®šä¹‰å‚æ•°ç”Ÿæˆ
python mega_main.py --target-records 1000000 --workers 8 --memory 2048
```

---

## ðŸ”§ æ ¸å¿ƒè„šæœ¬è¯´æ˜Ž

### 1. quick_mega_data.py - å¿«é€Ÿæ¼”ç¤ºè„šæœ¬
**ç”¨é€”**: å¿«é€Ÿç”Ÿæˆæ¼”ç¤ºç”¨çš„å¤§é‡æ•°æ®  
**ç‰¹ç‚¹**: 
- é€‚åˆæ¼”ç¤ºå’Œæµ‹è¯•çŽ¯å¢ƒ
- ç”Ÿæˆ1000å­¦ç”Ÿ + 50æ•™å¸ˆ
- æ‰§è¡Œæ—¶é—´çº¦30ç§’
- å†…å­˜å ç”¨ä½Ž

**ä½¿ç”¨åœºæ™¯**: 
- æ–°çŽ¯å¢ƒéªŒè¯
- åŠŸèƒ½æ¼”ç¤º
- å¿«é€Ÿæµ‹è¯•

### 2. generate_demo_mega_data.py - å¢žå¼ºæ¼”ç¤ºè„šæœ¬
**ç”¨é€”**: ç”Ÿæˆæ›´çœŸå®žçš„å¤§è§„æ¨¡æ¼”ç¤ºæ•°æ®  
**ç‰¹ç‚¹**:
- æ”¯æŒä¸­æ–‡å‡æ•°æ®
- 8000å­¦ç”Ÿ + 200æ•™å¸ˆ + 500è¯¾ç¨‹
- åŒ…å«é€‰è¯¾å…³ç³»
- æ‰¹å¤„ç†ä¼˜åŒ–

**ä½¿ç”¨åœºæ™¯**:
- æ€§èƒ½æµ‹è¯•
- ç”¨æˆ·ç•Œé¢æµ‹è¯•
- åŠŸèƒ½å®Œæ•´æ€§éªŒè¯

### 3. import_mega_data.py - ä¸“ä¸šå¯¼å…¥ç³»ç»Ÿ
**ç”¨é€”**: ç™¾ä¸‡çº§æ•°æ®çš„ä¸“ä¸šå¯¼å…¥å·¥å…·  
**ç‰¹ç‚¹**:
- å†…å­˜ä¼˜åŒ–å’Œç›‘æŽ§
- è¿›åº¦æ¡æ˜¾ç¤º
- é”™è¯¯å¤„ç†å’Œé‡è¯•
- æ£€æŸ¥ç‚¹æœºåˆ¶

**ä½¿ç”¨åœºæ™¯**:
- ç”Ÿäº§çŽ¯å¢ƒæ•°æ®è¿ç§»
- å¤§è§„æ¨¡åŽ‹åŠ›æµ‹è¯•
- æ€§èƒ½åŸºå‡†æµ‹è¯•

---

## ðŸ“ˆ æ€§èƒ½ä¼˜åŒ–é…ç½®

### å†…å­˜ä¼˜åŒ–å‚æ•°
```python
# é…ç½®ç¤ºä¾‹
MEMORY_CONFIG = {
    'max_memory_gb': 2,          # æœ€å¤§å†…å­˜é™åˆ¶
    'batch_size': 10000,         # æ‰¹æ¬¡å¤§å°
    'gc_threshold': 0.8,         # åžƒåœ¾å›žæ”¶é˜ˆå€¼
    'enable_streaming': True,    # å¯ç”¨æµå¼å¤„ç†
    'enable_compression': True   # å¯ç”¨åŽ‹ç¼©
}
```

### æ‰¹å¤„ç†ä¼˜åŒ–
```python
# åŠ¨æ€æ‰¹æ¬¡å¤§å°è°ƒæ•´
def optimize_batch_size(current_batch_size, memory_ratio):
    if memory_ratio > 0.8:
        return max(1000, current_batch_size // 2)
    elif memory_ratio < 0.5:
        return min(50000, current_batch_size * 2)
    return current_batch_size
```

---

## ðŸ› ï¸ é…ç½®æ–‡ä»¶è¯´æ˜Ž

### mega_scale_config.yml æ ¸å¿ƒé…ç½®
```yaml
# æ•°æ®ç”Ÿæˆé…ç½®
generation:
  target_records: 1000000      # ç›®æ ‡è®°å½•æ•°
  scale: "huge"                # æ•°æ®è§„æ¨¡
  conflict_difficulty: "mixed" # å†²çªéš¾åº¦

# æ‰¹å¤„ç†é…ç½®
batch_processing:
  batch_size: 50000           # æ‰¹æ¬¡å¤§å°
  max_memory_mb: 2048         # å†…å­˜é™åˆ¶
  max_workers: 8              # å·¥ä½œè¿›ç¨‹æ•°

# æ€§èƒ½ä¼˜åŒ–
memory_optimization:
  enable_object_pool: true    # å¯¹è±¡æ± 
  enable_streaming: true      # æµå¼å¤„ç†
  enable_compression: true    # åŽ‹ç¼©å­˜å‚¨
```

---

## ðŸ“Š ç›‘æŽ§ä¸Žè¯Šæ–­

### 1. å®žæ—¶ç›‘æŽ§
```bash
# æŸ¥çœ‹æ•°æ®ç”Ÿæˆè¿›åº¦
docker compose logs -f backend

# ç›‘æŽ§å®¹å™¨èµ„æºä½¿ç”¨
docker stats course_management_backend

# æŸ¥çœ‹æ•°æ®åº“è¿žæŽ¥
docker compose exec db psql -U postgres -c "SELECT count(*) FROM pg_stat_activity;"
```

### 2. æ•°æ®éªŒè¯
```bash
# éªŒè¯ç”¨æˆ·æ•°æ®
docker compose exec backend python -c "
import os; os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'course_management.settings')
import django; django.setup()
from django.contrib.auth import get_user_model
User = get_user_model()
print(f'æ€»ç”¨æˆ·: {User.objects.count():,}')
print(f'å­¦ç”Ÿ: {User.objects.filter(user_type=\"student\").count():,}')  
print(f'æ•™å¸ˆ: {User.objects.filter(user_type=\"teacher\").count():,}')
print(f'ç™¾ä¸‡çº§ç”¨æˆ·: {User.objects.filter(username__startswith=\"mega_\").count():,}')
"
```

### 3. æ€§èƒ½åˆ†æž
```bash
# æ•°æ®åº“æ€§èƒ½åˆ†æž
docker compose exec db psql -U postgres course_management -c "
SELECT schemaname,tablename,attname,avg_width,n_distinct,correlation 
FROM pg_stats 
WHERE tablename='users_user' 
ORDER BY avg_width DESC LIMIT 10;
"
```

---

## ðŸš¨ æ•…éšœæŽ’é™¤

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 1. å†…å­˜ä¸è¶³
**ç—‡çŠ¶**: å®¹å™¨é‡å¯æˆ–OOMé”™è¯¯  
**è§£å†³æ–¹æ¡ˆ**:
```bash
# é™ä½Žæ‰¹æ¬¡å¤§å°
docker compose exec backend python -c "
# ä¿®æ”¹æ‰¹æ¬¡å¤§å°ä¸ºè¾ƒå°å€¼
BATCH_SIZE = 1000  # é™ä½Žåˆ°1000
"

# å¯ç”¨æ›´ç§¯æžçš„åžƒåœ¾å›žæ”¶
docker compose exec backend python -c "
import gc
gc.set_threshold(100, 10, 10)  # æ›´é¢‘ç¹çš„åžƒåœ¾å›žæ”¶
"
```

#### 2. æ•°æ®åº“è¿žæŽ¥è¶…æ—¶
**ç—‡çŠ¶**: è¿žæŽ¥æ•°æ®åº“å¤±è´¥  
**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
docker compose exec db pg_isready -U postgres

# é‡å¯æ•°æ®åº“æœåŠ¡
docker compose restart db

# è°ƒæ•´è¿žæŽ¥æ± è®¾ç½®
# åœ¨Django settingsä¸­å¢žåŠ :
# DATABASES['default']['CONN_MAX_AGE'] = 60
```

#### 3. ç£ç›˜ç©ºé—´ä¸è¶³
**ç—‡çŠ¶**: å†™å…¥å¤±è´¥  
**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥ç£ç›˜ä½¿ç”¨
docker system df

# æ¸…ç†æœªä½¿ç”¨çš„å®¹å™¨å’Œé•œåƒ
docker system prune -a

# å¯ç”¨æ•°æ®åŽ‹ç¼©
# åœ¨é…ç½®ä¸­è®¾ç½®: enable_compression: true
```

---

## ðŸ“ æ•°æ®æ¸…ç†

### æ¸…ç†ç™¾ä¸‡çº§æµ‹è¯•æ•°æ®
```bash
# æ¸…ç†æ‰€æœ‰ç™¾ä¸‡çº§æ¼”ç¤ºæ•°æ®
docker compose exec backend python -c "
import os; os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'course_management.settings')
import django; django.setup()
from django.contrib.auth import get_user_model
from apps.courses.models import Course, Enrollment

User = get_user_model()

# åˆ é™¤ç™¾ä¸‡çº§æµ‹è¯•ç”¨æˆ·
deleted_users = User.objects.filter(username__startswith='mega_').delete()
print(f'åˆ é™¤ç”¨æˆ·: {deleted_users[0]}')

# åˆ é™¤ç›¸å…³è¯¾ç¨‹
deleted_courses = Course.objects.filter(name__startswith='MEGA_').delete()
print(f'åˆ é™¤è¯¾ç¨‹: {deleted_courses[0]}')

print('æ¸…ç†å®Œæˆ!')
"
```

### é‡ç½®åˆ°åˆå§‹çŠ¶æ€
```bash
# å®Œå…¨é‡ç½®æ•°æ®åº“ï¼ˆè°¨æ…Žä½¿ç”¨ï¼‰
docker compose down
docker volume rm course-management-system_postgres_data
docker compose up -d

# é‡æ–°åˆå§‹åŒ–
docker compose exec backend python manage.py migrate
docker compose exec backend python create_admin_user.py
docker compose exec backend python create_test_users.py
```

---

## ðŸŽ¯ ä½¿ç”¨å»ºè®®

### 1. å¼€å‘çŽ¯å¢ƒ
- ä½¿ç”¨ `quick_mega_data.py` è¿›è¡Œå¿«é€Ÿæµ‹è¯•
- æ•°æ®é‡æŽ§åˆ¶åœ¨1000-10000èŒƒå›´
- å®šæœŸæ¸…ç†æµ‹è¯•æ•°æ®

### 2. æµ‹è¯•çŽ¯å¢ƒ
- ä½¿ç”¨ `generate_demo_mega_data.py` ç”Ÿæˆä¸­ç­‰è§„æ¨¡æ•°æ®
- æ•°æ®é‡å¯è¾¾10ä¸‡çº§åˆ«
- å¯ç”¨æ€§èƒ½ç›‘æŽ§

### 3. ç”Ÿäº§çŽ¯å¢ƒ
- ä½¿ç”¨ä¸“ä¸šçš„ `import_mega_data.py`
- é…ç½®å……è¶³çš„å†…å­˜å’Œå­˜å‚¨
- å¯ç”¨æ‰€æœ‰ä¼˜åŒ–é€‰é¡¹
- è®¾ç½®è¯¦ç»†çš„ç›‘æŽ§å’Œå‘Šè­¦

---

## ðŸ“‹ éƒ¨ç½²æ£€æŸ¥æ¸…å•

### ç™¾ä¸‡çº§æ•°æ®å¯¼å…¥å‰æ£€æŸ¥
- [ ] ç³»ç»Ÿå†…å­˜ â‰¥ 4GBï¼ˆæŽ¨è8GBï¼‰
- [ ] å¯ç”¨ç£ç›˜ç©ºé—´ â‰¥ 20GB
- [ ] æ•°æ®åº“è¿žæŽ¥æ­£å¸¸
- [ ] Dockerå®¹å™¨å¥åº·è¿è¡Œ
- [ ] å¤‡ä»½çŽ°æœ‰é‡è¦æ•°æ®

### å¯¼å…¥è¿‡ç¨‹ä¸­ç›‘æŽ§
- [ ] å†…å­˜ä½¿ç”¨çŽ‡ < 80%
- [ ] ç£ç›˜ä½¿ç”¨çŽ‡ < 90%
- [ ] æ•°æ®åº“è¿žæŽ¥æ•°æ­£å¸¸
- [ ] é”™è¯¯æ—¥å¿—æ— å¼‚å¸¸
- [ ] è¿›åº¦æ­£å¸¸æŽ¨è¿›

### å¯¼å…¥å®ŒæˆåŽéªŒè¯
- [ ] æ•°æ®æ€»é‡ç¬¦åˆé¢„æœŸ
- [ ] æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
- [ ] ç³»ç»ŸåŠŸèƒ½æ­£å¸¸
- [ ] æ€§èƒ½å“åº”æ­£å¸¸
- [ ] æ¸…ç†ä¸´æ—¶æ–‡ä»¶

---

**ðŸ“… æ–‡æ¡£æ›´æ–°**: 2024å¹´8æœˆ31æ—¥  
**ðŸ”– ç‰ˆæœ¬**: v1.1.0  
**ðŸŽ¯ çŠ¶æ€**: å·²éªŒè¯å¹¶éƒ¨ç½²æˆåŠŸ  
**ðŸ“Š æµ‹è¯•ç»“æžœ**: æˆåŠŸç”Ÿæˆ1,050æ¡æ¼”ç¤ºè®°å½•  

---

*æœ¬æ–‡æ¡£æä¾›äº†å®Œæ•´çš„ç™¾ä¸‡çº§æ•°æ®å¤„ç†æ–¹æ¡ˆï¼Œé€‚ç”¨äºŽä¸åŒè§„æ¨¡çš„éƒ¨ç½²éœ€æ±‚ã€‚å¦‚éœ€æ›´å¤§è§„æ¨¡çš„æ•°æ®å¤„ç†ï¼Œè¯·æ ¹æ®å®žé™…çŽ¯å¢ƒè°ƒæ•´ç›¸å…³å‚æ•°ã€‚*