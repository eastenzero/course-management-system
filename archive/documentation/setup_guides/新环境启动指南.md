# 课程管理系统 - 新环境启动指南

## 系统概述
课程管理系统是一个基于Django + React的智能课程排表管理系统，支持多用户角色（管理员、教师、学生），提供课程管理、智能排课、成绩管理等功能。

## 技术栈
- **后端**: Django 4.2.7 + Django REST Framework + PostgreSQL
- **前端**: React 18 + TypeScript + Vite + Ant Design
- **缓存**: Redis
- **消息队列**: Celery
- **数据库**: PostgreSQL 16

## 环境要求
- Ubuntu 20.04+ / Debian 11+ / CentOS 8+
- Python 3.12+
- Node.js 18+
- PostgreSQL 16+
- Redis 7.0+

## 安装步骤

### 1. 系统依赖安装

```bash
# 更新系统包
sudo apt update && sudo apt upgrade -y

# 安装基础依赖
sudo apt install -y python3.12-venv postgresql postgresql-contrib redis-server nodejs npm

# 安装Python开发工具
sudo apt install -y python3-pip python3-dev build-essential

# 启动服务
sudo service postgresql start
sudo service redis-server start
```

### 2. 数据库配置

```bash
# 设置PostgreSQL密码
sudo -u postgres psql -c "ALTER USER postgres PASSWORD 'postgres123';"

# 修改认证方式
sudo sed -i 's/peer/md5/g' /etc/postgresql/16/main/pg_hba.conf
sudo service postgresql restart

# 创建数据库
sudo -u postgres createdb course_management
```

### 3. 后端环境配置

```bash
# 进入项目目录
cd /path/to/course-management-system/course-management-system

# 创建Python虚拟环境
cd backend
python3 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt
pip install setuptools  # 修复pkg_resources依赖

# 创建日志目录
mkdir -p logs

# 配置环境变量
cp ../.env.example ../.env
# 编辑.env文件，根据实际情况修改配置
```

### 4. 数据库初始化

```bash
# 激活虚拟环境
source venv/bin/activate

# 运行迁移
python manage.py makemigrations
python manage.py migrate

# 创建超级用户（可选）
python manage.py createsuperuser
# 或者使用预设的管理员账户：admin/admin123
```

### 5. 前端环境配置

```bash
# 进入前端目录
cd ../frontend

# 安装依赖
npm install

# 构建项目（生产环境）
npm run build

# 开发环境直接启动
npm run dev
```

## 启动服务

### 开发环境启动

```bash
# 终端1：启动后端
source venv/bin/activate
python manage.py runserver 0.0.0.0:8000

# 终端2：启动前端
cd frontend
npm run dev

# 终端3：启动Celery worker（可选）
cd backend
source venv/bin/activate
celery -A course_management worker -l info

# 终端4：启动Celery beat（可选）
celery -A course_management beat -l info
```

### 生产环境启动

```bash
# 使用Gunicorn启动后端
cd backend
source venv/bin/activate
gunicorn course_management.wsgi:application --bind 0.0.0.0:8000 --workers 4

# 使用Nginx反向代理前端
# 前端构建后部署到Nginx静态文件目录
```

## 服务验证

### 后端服务检查
```bash
# 检查API文档
curl http://localhost:8000/api/schema/

# 测试登录接口
curl -X POST http://localhost:8000/api/v1/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'

# 检查管理员界面
curl -I http://localhost:8000/admin/
```

### 前端服务检查
```bash
# 检查前端页面
curl -I http://localhost:3000

# 检查API代理
curl -I http://localhost:3000/api/v1/auth/login/
```

## 默认账户信息

### 管理员账户
- 用户名: `admin`
- 密码: `admin123`
- 邮箱: `admin@example.com`

### 测试账户（可选）
系统支持创建多种角色的测试账户，包括教师、学生等不同权限的用户。

## 配置文件说明

### 后端配置 (.env)
```env
# 数据库配置
DB_NAME=course_management
DB_USER=postgres
DB_PASSWORD=postgres123
DB_HOST=localhost
DB_PORT=5432

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379

# Django配置
SECRET_KEY=your-secret-key
DEBUG=True
ALLOWED_HOSTS=localhost,127.0.0.1

# CORS配置
CORS_ALLOWED_ORIGINS=http://localhost:3000
```

### 前端配置 (vite.config.ts)
```typescript
server: {
  port: 3000,
  host: '0.0.0.0',
  proxy: {
    '/api': {
      target: 'http://localhost:8000',
      changeOrigin: true,
    },
  },
}
```

## 常见问题解决

### 1. PostgreSQL连接失败
```bash
# 检查PostgreSQL状态
sudo service postgresql status

# 检查端口监听
sudo netstat -tulnp | grep 5432

# 检查用户权限
sudo -u postgres psql -c "\du"
```

### 2. Redis连接失败
```bash
# 检查Redis状态
sudo service redis-server status

# 测试Redis连接
redis-cli ping
```

### 3. 端口冲突
```bash
# 检查端口占用
sudo netstat -tulnp | grep 8000  # 后端端口
sudo netstat -tulnp | grep 3000  # 前端端口
sudo netstat -tulnp | grep 6379  # Redis端口
```

### 4. 权限问题
```bash
# 修复文件权限
sudo chown -R $USER:$USER /path/to/project
chmod +x manage.py
```

## 服务管理

### 创建系统服务（可选）

#### PostgreSQL服务
```bash
sudo systemctl enable postgresql
sudo systemctl start postgresql
```

#### Redis服务
```bash
sudo systemctl enable redis-server
sudo systemctl start redis-server
```

#### 后端服务（systemd）
创建 `/etc/systemd/system/course-backend.service`:
```ini
[Unit]
Description=Course Management Backend
After=network.target postgresql.service redis.service

[Service]
User=your-user
WorkingDirectory=/path/to/course-management-system/course-management-system/backend
ExecStart=/path/to/venv/bin/gunicorn course_management.wsgi:application --bind 0.0.0.0:8000
Restart=always

[Install]
WantedBy=multi-user.target
```

#### 前端服务（Nginx）
创建 `/etc/nginx/sites-available/course-frontend`:
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        root /path/to/course-management-system/course-management-system/frontend/dist;
        try_files $uri $uri/ /index.html;
    }
    
    location /api/ {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

## 监控和维护

### 日志查看
```bash
# Django日志
tail -f backend/logs/course_management.log

# 系统日志
sudo journalctl -u postgresql -f
sudo journalctl -u redis-server -f
```

### 性能监控
- 使用Django管理后台监控数据库性能
- 使用Redis CLI监控缓存命中率
- 使用系统工具监控资源使用情况

### 备份策略
```bash
# 数据库备份
pg_dump course_management > backup_$(date +%Y%m%d).sql

# 配置文件备份
cp -r .env backend/course_management/settings.py backups/
```

## 安全建议

1. **修改默认密码**: 立即修改所有默认密码
2. **配置防火墙**: 仅开放必要端口
3. **使用HTTPS**: 生产环境启用SSL证书
4. **定期更新**: 保持系统和依赖包更新
5. **访问控制**: 配置适当的用户权限

## 技术支持

如遇到问题，请检查：
1. 所有服务是否正常运行
2. 配置文件是否正确
3. 端口是否被占用
4. 日志文件中的错误信息
5. 网络连接是否正常

系统已成功启动并运行！
- 后端API: http://localhost:8000
- 前端界面: http://localhost:3000
- API文档: http://localhost:8000/api/schema/
- 管理后台: http://localhost:8000/admin/