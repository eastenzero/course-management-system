
# 模块1：后端核心开发提示词

## 前置环境配置提示词

### 系统环境要求
你是一位资深的Python Django后端开发专家，需要为校园课程表管理系统构建稳定、高性能的后端服务。在开始开发前，请确保以下环境已正确配置：

**操作系统**: Linux Ubuntu 22.04 LTS
**Python版本**: 3.11.x
**数据库**: PostgreSQL 15.x
**缓存**: Redis 7.x
**消息队列**: Celery + Redis

### 环境配置检查清单
```bash
# 1. 验证Python版本
python3.11 --version

# 2. 创建虚拟环境
python3.11 -m venv course_management_env
source course_management_env/bin/activate

# 3. 安装核心依赖
pip install django==4.2.7
pip install djangorestframework==3.14.0
pip install psycopg2-binary==2.9.7
pip install redis==5.0.1
pip install celery==5.3.4
pip install django-cors-headers==4.3.1
pip install django-filter==23.3
pip install drf-spectacular==0.26.5

# 4. 验证数据库连接
psql -h localhost -U course_admin -d course_management_db -c "SELECT version();"

# 5. 验证Redis连接
redis-cli ping
```

## 核心开发任务

### 任务1：Django项目初始化与配置

**目标**: 创建一个结构清晰、配置完善的Django项目骨架

**具体要求**:
1. 使用Django 4.2创建项目，项目名称为`course_management`
2. 创建以下核心应用：
   - `users` (用户管理)
   - `courses` (课程管理)
   - `schedules` (排课管理)
   - `classrooms` (教室管理)
   - `analytics` (数据分析)

3. 配置settings.py，包含：
   - 数据库配置 (PostgreSQL)
   - Redis缓存配置
   - CORS设置
   - DRF配置
   - 国际化设置 (中文)
   - 时区设置 (Asia/Shanghai)
   - 日志配置

4. 设置项目目录结构：
```
course_management/
├── config/
│   ├── settings/
│   │   ├── base.py
│   │   ├── development.py
│   │   ├── production.py
│   └── urls.py
├── apps/
│   ├── users/
│   ├── courses/
│   ├── schedules/
│   ├── classrooms/
│   └── analytics/
├── utils/
├── requirements/
└── manage.py
```

**性能要求**:
- 支持并发用户数: 1000+
- API响应时间: <200ms
- 数据库查询优化: 使用select_related和prefetch_related

### 任务2：用户认证与权限系统

**目标**: 实现安全可靠的用户认证和细粒度权限控制

**用户角色定义**:
- **超级管理员**: 系统全部权限
- **教务管理员**: 课程安排、教室管理、数据统计
- **教师**: 查看自己的课程、申请调课
- **学生**: 查看课程表、选课退课

**核心功能**:
1. 用户模型扩展
```python
class User(AbstractUser):
    user_type = models.CharField(max_length=20, choices=USER_TYPE_CHOICES)
    employee_id = models.CharField(max_length=20, unique=True, null=True)
    student_id = models.CharField(max_length=20, unique=True, null=True)
    department = models.CharField(max_length=100)
    phone = models.CharField(max_length=15)
    avatar = models.ImageField(upload_to='avatars/', null=True)
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
```

2. JWT认证实现
3. 基于角色的权限控制 (RBAC)
4. API接口权限装饰器
5. 密码安全策略 (复杂度验证、定期更换)

**安全要求**:
- 密码加密存储 (bcrypt)
- JWT Token过期机制
- 防止SQL注入
- XSS防护
- CSRF保护

### 任务3：数据模型设计与实现

**目标**: 设计高效、可扩展的数据模型

**核心模型**:

1. **课程模型 (Course)**
```python
class Course(models.Model):
    code = models.CharField(max_length=20, unique=True)  # 课程代码
    name = models.CharField(max_length=100)  # 课程名称
    credits = models.PositiveIntegerField()  # 学分
    hours = models.PositiveIntegerField()  # 学时
    department = models.CharField(max_length=100)  # 开课院系
    description = models.TextField(blank=True)  # 课程描述
    prerequisites = models.ManyToManyField('self', blank=True)  # 先修课程
    teachers = models.ManyToManyField(User, related_name='teaching_courses')
    max_students = models.PositiveIntegerField(default=50)  # 最大选课人数
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
```

2. **教室模型 (Classroom)**
```python
class Classroom(models.Model):
    building = models.CharField(max_length=50)  # 教学楼
    room_number = models.CharField(max_length=20)  # 教室号
    capacity = models.PositiveIntegerField()  # 容量
    room_type = models.CharField(max_length=20, choices=ROOM_TYPE_CHOICES)
    equipment = models.JSONField(default=dict)  # 设备信息
    is_available = models.BooleanField(default=True)
    location_description = models.TextField(blank=True)
```

3. **时间段模型 (TimeSlot)**
```python
class TimeSlot(models.Model):
    name = models.CharField(max_length=50)  # 如"第1节课"
    start_time = models.TimeField()
    end_time = models.TimeField()
    order = models.PositiveIntegerField()  # 排序
    is_active = models.BooleanField(default=True)
```

4. **课程安排模型 (Schedule)**
```python
class Schedule(models.Model):
    course = models.ForeignKey(Course, on_delete=models.CASCADE)
    classroom = models.ForeignKey(Classroom, on_delete=models.CASCADE)
    time_slot = models.ForeignKey(TimeSlot, on_delete=models.CASCADE)
    day_of_week = models.PositiveIntegerField(choices=DAY_CHOICES)
    week_range = models.CharField(max_length=50)  # 如"1-16周"
    semester = models.CharField(max_length=20)
    academic_year = models.CharField(max_length=10)
    teacher = models.ForeignKey(User, on_delete=models.CASCADE)
    status = models.CharField(max_length=20, default='active')
    created_at = models.DateTimeField(auto_now_add=True)
```

**数据库优化要求**:
- 添加适当的数据库索引
- 使用外键约束保证数据完整性
- 实现软删除机制
- 数据库连接池配置

### 任务4：RESTful API设计与实现

**目标**: 设计符合RESTful规范的API接口

**API设计原则**:
- 使用HTTP动词 (GET, POST, PUT, DELETE)
- 统一的响应格式
- 适当的HTTP状态码
- API版本控制
- 请求限流和缓存

**核心API端点**:

1. **用户管理API**
```
POST /api/v1/auth/login/          # 用户登录
POST /api/v1/auth/logout/         # 用户登出
POST /api/v1/auth/refresh/        # 刷新Token
GET  /api/v1/users/profile/       # 获取用户信息
PUT  /api/v1/users/profile/       # 更新用户信息
```

2. **课程管理API**
```
GET    /api/v1/courses/           # 获取课程列表
POST   /api/v1/courses/           # 创建课程
GET    /api/v1/courses/{id}/      # 获取课程详情
PUT    /api/v1/courses/{id}/      # 更新课程
DELETE /api/v1/courses/{id}/      # 删除课程
```

3. **排课管理API**
```
GET    /api/v1/schedules/         # 获取课程表
POST   /api/v1/schedules/         # 创建课程安排
PUT    /api/v1/schedules/{id}/    # 更新课程安排
DELETE /api/v1/schedules/{id}/    # 删除课程安排
POST   /api/v1/schedules/batch/   # 批量排课
```

**响应格式标准**:
```json
{
    "code": 200,
    "message": "success",
    "data": {},
    "timestamp": "2024-01-01T00:00:00Z"
}
```

### 任务5：核心业务逻辑实现

**目标**: 实现高效的排课算法和冲突检测机制

**排课算法要求**:
1. 支持自动排课和手动调整
2. 考虑教师时间偏好
3. 教室容量匹配
4. 避免时间冲突
5. 均衡分布原则

**冲突检测规则**:
- 同一教师同一时间不能有多门课
- 同一教室同一时间不能安排多门课
- 同一班级同一时间不能有多门必修课
- 检查教室容量是否满足选课人数

**性能优化**:
- 使用Redis缓存热点数据
- 数据库查询优化
- 异步任务处理
- 分页查询实现

### 开发规范要求

1. **代码质量**:
   - 遵循PEP 8编码规范
   - 添加详细的文档字符串
   - 单元测试覆盖率 > 80%
   - 使用类型注解

2. **错误处理**:
   - 统一的异常处理机制
   - 详细的错误日志记录
   - 用户友好的错误信息

3. **安全性**:
   - 输入数据验证
   - SQL注入防护
   - XSS攻击防护
   - 敏感信息加密

请按照以上要求开始后端核心功能的开发，确保代码质量和系统性能达到生产环境标准。
